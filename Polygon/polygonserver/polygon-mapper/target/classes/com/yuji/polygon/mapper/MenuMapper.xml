<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yuji.polygon.mapper.MenuMapper">

    <resultMap id="BaseResultMap" type="com.yuji.polygon.entity.Menu">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="icon" property="icon"/>
        <result column="path" property="path"/>
        <result column="component" property="component"/>
        <result column="parent_id" property="parentId"/>
        <result column="enabled" property="enabled" />
        <association property="meta" javaType="com.yuji.polygon.entity.Meta">
            <result column="keep_alive" property="keepAlive" />
            <result column="require_auth" property="requireAuth" />
        </association>

    </resultMap>
    
    <resultMap id="MenuResult" type="com.yuji.polygon.entity.Menu" extends="BaseResultMap" >
        <collection property="children" ofType="com.yuji.polygon.entity.Menu">
            <id column="id2" property="id" />
            <result column="name2" property="name"/>
            <result column="icon2" property="icon"/>
            <result column="path2" property="path"/>
            <result column="component2" property="component"/>
            <result column="parent_id2" property="parentId"/>
            <result column="enabled2" property="enabled" />
            <association property="meta" javaType="com.yuji.polygon.entity.Meta">
                <result column="keep_alive2" property="keepAlive" />
                <result column="require_auth2" property="requireAuth" />
            </association>
        </collection>
    </resultMap>

    <resultMap id="MenuWithPermission" type="com.yuji.polygon.entity.Menu" extends="BaseResultMap" >
        <collection property="permissions" ofType="com.yuji.polygon.entity.Permission" >
            <id column="pid" property="id" />
            <result column="pname" property="name" />
        </collection>
    </resultMap>

    <resultMap id="MenuWithChildren" type="com.yuji.polygon.entity.Menu" extends="BaseResultMap" >
        <id column="id1" property="id" />
        <result column="name1" property="name" />
        <collection property="children" ofType="com.yuji.polygon.entity.Menu">
            <id column="id2" property="id" />
            <result column="name2" property="name" />
            <collection property="children" ofType="com.yuji.polygon.entity.Menu" >
                <id column="id3" property="id" />
                <result column="name3" property="name" />
            </collection>
        </collection>
    </resultMap>

    <insert id="insertMenu" parameterType="com.yuji.polygon.entity.Menu" useGeneratedKeys="true" keyProperty="id">
        insert into poly_menu (name,url,icon,path,component,keep_alive,require_auth,parent_id,enabled)
        values (#{name},#{url},#{icon},#{path},#{component},#{keepAlive},#{requireAuth},#{parentId},#{enabled})
    </insert>

    <select id="getMenuByEmployeeId" resultMap="MenuResult">
        select distinct
            m1.*,
            m2.`id` as id2,
            m2.`component` as component2,
            m2.`enabled` as enabled2,
            m2.`icon` as icon2,
            m2.`keep_alive` as keepAlive2,
            m2.`name` as name2,
            m2.`parent_id` as parentId2,
            m2.`require_auth` as requireAuth2,
            m2.`path` as path2
        from
            poly_menu m1,
            poly_menu m2,
            poly_employee_role er,
            poly_role_menu rm
        where
            m1.`id` = m2.`parent_id`
            and er.`eid` = #{eid} and er.`rid`=rm.`rid` and rm.`mid` =m2.`id`
            order by m1.`id`,m2.`id`
    </select>

    <select id="getAllMenuWithPermission" resultMap="MenuWithPermission">
        select
            m.*,
            p.`id` as pid,
            p.`name` as pname
        from
            poly_role r,
            poly_menu m,
            poly_permission p,
            poly_role_menu rm,
            poly_menu_permission mp
        where
            r.`id`=rm.`rid` and rm.`mid`=m.`id` and m.`id`=mp.`mid` and mp.`pid`=p.`id`
    </select>

    <select id="getAllMenu" resultMap="MenuWithChildren">
        select
            m1.`id` as id1,
            m1.`name` as name1,
            m2.`id` as id2,
            m2.`name` as name2,
            m3.`id` as id3,
            m3.`name` as name3
        from
            poly_menu m1,
            poly_menu m2,
            poly_menu m3
        where
            m1.`id` = m2.`parent_id` and m2.`id` = m3.`parent_id`
            order by m1.`id`,m2.`id`,m3.`id`
    </select>

</mapper>